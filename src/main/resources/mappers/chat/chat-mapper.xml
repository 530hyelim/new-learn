<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chat">
	<!-- 친구 목록 조회 -->
	<select id="selectFriendList" resultMap="friendListResultMap">
		SELECT
		    M.USER_NO,
		    I.CHANGE_NAME,
		    M.USER_NAME,
		    MP.STATUS_MESSAGE
		FROM FRIEND F
		LEFT JOIN MEMBER M ON F.FRIEND_USER_NO = M.USER_NO
		LEFT JOIN MYPAGE MP ON F.FRIEND_USER_NO = MP.USER_NO
		LEFT JOIN MYPAGE_IMG MPI ON MP.MYPAGE_NO = MPI.MYPAGE_NO AND TYPE='profile'
		LEFT JOIN IMAGE I ON MPI.IMG_NO = I.IMG_NO
		WHERE F.USER_NO = #{userNo} AND F.RESPONSE_STATUS = '수락'
	</select>
	<resultMap type="friendDTO" id="friendListResultMap">
		<id column="user_no" property="userNo"/>
		<result column="change_name" property="changeName"/>
		<result column="user_name" property="userName"/>
		<result column="status_message" property="statusMessage"/>
	</resultMap>
	
	<!-- 채팅방 목록 조회 -->
	<select id="selectChattingRoomList" resultMap="chattingRoomListResultMap">
		SELECT 
		    CR.CHAT_ROOM_NO,
		    CR.CHAT_TITLE,
		    CR.CHAT_PUBLIC,
		    M.USER_NAME,
		    I.CHANGE_NAME,
		    CJC.PARTICIPANT_COUNT,
		    CJ.ROOM_NOTI,
		    UNREAD.UNREAD_COUNT
		FROM CHAT_ROOM CR
		LEFT JOIN MEMBER M ON CR.USER_NO = M.USER_NO
		LEFT JOIN MYPAGE MP ON CR.USER_NO = MP.USER_NO
		LEFT JOIN MYPAGE_IMG MPI ON MP.MYPAGE_NO = MPI.MYPAGE_NO AND MPI.TYPE = 'profile'
		LEFT JOIN IMAGE I ON MPI.IMG_NO = I.IMG_NO
		LEFT JOIN (
		    SELECT 
		        CHAT_ROOM_NO,
		        COUNT(USER_NO) AS PARTICIPANT_COUNT
		    FROM CHAT_JOIN 
		    GROUP BY CHAT_ROOM_NO
		) CJC ON CR.CHAT_ROOM_NO = CJC.CHAT_ROOM_NO
		LEFT JOIN (
		    SELECT
		        CM.CHAT_ROOM_NO,
		        COUNT(CM.MESSAGE_NO) AS UNREAD_COUNT
		    FROM CHAT_MESSAGE CM
		    LEFT JOIN CHAT_MESSAGE_READ CMR ON CM.MESSAGE_NO = CMR.MESSAGE_NO AND CMR.USER_NO = 3
		    WHERE CMR.READ_STATUS IS NULL OR CMR.READ_STATUS != 'Y'
		    GROUP BY CM.CHAT_ROOM_NO
		) UNREAD ON CR.CHAT_ROOM_NO = UNREAD.CHAT_ROOM_NO
		LEFT JOIN CHAT_JOIN CJ ON CR.CHAT_ROOM_NO = CJ.CHAT_ROOM_NO AND CJ.USER_NO = 3
		WHERE CJ.USER_NO IS NOT NULL
	</select>
	<resultMap type="chattingRoomDTO" id="chattingRoomListResultMap">
		<id column="chat_room_no" property="chatRoomNo"/>
		<result column="chat_title" property="chatTitle"/>
		<result column="chat_public" property="chatPublic"/>
		<result column="user_name" property="userName"/>
		<result column="change_name" property="changeName"/>
		<result column="participant_count" property="participantCount"/>
		<result column="room_noti" property="roomNoti"/>
		<result column="unread_count" property="unreadCount"/>
	</resultMap>

	<!-- 채팅방 생성 -->
	<insert id="createRoom" parameterType="map">
        <selectKey keyProperty="chatRoomNo" resultType="int" order="BEFORE">
            SELECT
                CASE WHEN MAX(CHAT_ROOM_NO) IS NULL
                    THEN 1
                    ELSE MAX(CHAT_ROOM_NO) + 1
                END
            FROM CHAT_ROOM
        </selectKey>

        INSERT INTO CHAT_ROOM VALUES
        (#{chatRoomNo}, #{userNo}, #{chatTitle}, DEFAULT,
        <choose>
            <when test="chatPublic == 'Y'">NULL</when>
            <otherwise>#{chatPw}</otherwise>
        </choose>, #{chatPublic}, DEFAULT)
    </insert>

    <insert id="insertUserJoin" parameterType="map">
        INSERT INTO CHAT_JOIN VALUES
        (#{userNo}, #{chatRoomNo}, DEFAULT, NULL, DEFAULT)
    </insert>

    <insert id="insertFriendJoin" parameterType="map">
        INSERT ALL
        <foreach collection="selectFriendList" item="friendUserNo">
            INTO CHAT_JOIN VALUES (#{friendUserNo}, #{chatRoomNo}, DEFAULT, NULL, DEFAULT)
        </foreach>
        SELECT * FROM DUAL
    </insert>
	
	
	
	
<!-- 	친구 프로필 조회
	<select id="friendProfile">
	
	</select> -->
</mapper>